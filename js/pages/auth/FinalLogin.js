const CopyIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="20px"
    viewBox="0 -960 960 960"
    width="20px"
    className="fill:gray-200 dark:fill-white"
  >
    <path d="M360-240q-29.7 0-50.85-21.15Q288-282.3 288-312v-480q0-29.7 21.15-50.85Q330.3-864 360-864h384q29.7 0 50.85 21.15Q816-821.7 816-792v480q0 29.7-21.15 50.85Q773.7-240 744-240H360Zm0-72h384v-480H360v480ZM216-96q-29.7 0-50.85-21.15Q144-138.3 144-168v-552h72v552h456v72H216Zm144-216v-480 480Z" />
  </svg>
);

const ThreeDotIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="20px"
    viewBox="0 -960 960 960"
    width="20px"
    className="fill:gray-200 dark:fill-white"
  >
    <path d="M479.79-192Q450-192 429-213.21t-21-51Q408-294 429.21-315t51-21Q510-336 531-314.79t21 51Q552-234 530.79-213t-51 21Zm0-216Q450-408 429-429.21t-21-51Q408-510 429.21-531t51-21Q510-552 531-530.79t21 51Q552-450 530.79-429t-51 21Zm0-216Q450-624 429-645.21t-21-51Q408-726 429.21-747t51-21Q510-768 531-746.79t21 51Q552-666 530.79-645t-51 21Z" />
  </svg>
);

const DeleteIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="20px"
    viewBox="0 -960 960 960"
    width="20px"
    className="fill:gray-200 dark:fill-white"
  >
    <path d="M312-144q-29.7 0-50.85-21.15Q240-186.3 240-216v-480h-48v-72h192v-48h192v48h192v72h-48v479.57Q720-186 698.85-165T648-144H312Zm336-552H312v480h336v-480ZM384-288h72v-336h-72v336Zm120 0h72v-336h-72v336ZM312-696v480-480Z" />
  </svg>
);

const PinIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="20px"
    viewBox="0 -960 960 960"
    width="20px"
    className="fill:gray-200 dark:fill-white"
  >
    <path d="M480.21-480Q510-480 531-501.21t21-51Q552-582 530.79-603t-51-21Q450-624 429-602.79t-21 51Q408-522 429.21-501t51 21ZM480-191q119-107 179.5-197T720-549q0-105-68.5-174T480-792q-103 0-171.5 69T240-549q0 71 60.5 161T480-191Zm0 95Q323.03-227.11 245.51-339.55 168-452 168-549q0-134 89-224.5T479.5-864q133.5 0 223 90.5T792-549q0 97-77 209T480-96Zm0-456Z" />
  </svg>
);

const EyeIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="24px"
    viewBox="0 -960 960 960"
    width="24px"
    className="fill-black dark:fill-white"
  >
    <path d="M480.18-353.85q60.97 0 103.47-42.68t42.5-103.65q0-60.97-42.68-103.47t-103.65-42.5q-60.97 0-103.47 42.68t-42.5 103.65q0 60.97 42.68 103.47t103.65 42.5ZM480-392q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm.11 152q-129.96 0-236.88-70.73Q136.31-381.46 83.08-500q53.23-118.54 160.04-189.27T479.89-760q129.96 0 236.88 70.73Q823.69-618.54 876.92-500q-53.23 118.54-160.04 189.27T480.11-240ZM480-500Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z" />
  </svg>
);

const EyeOffIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="24px"
    viewBox="0 -960 960 960"
    width="24px"
    className="fill-black dark:fill-white"
  >
    <path d="M617.85-454.15 586-486q9-52.38-29.69-90.69Q517.62-615 466-606l-31.85-31.85q10.08-4.15 21.04-6.23 10.96-2.07 24.81-2.07 61.15 0 103.65 42.5 42.5 42.5 42.5 103.65 0 13.85-2.07 25.58-2.08 11.73-6.23 20.27Zm126.46 122.92L714-358q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-31.23-31.23q34.85-13.15 70.92-18.96Q443.77-760 480-760q130.23 0 238.23 71.58 108 71.57 158.69 188.42-21.46 48.23-54.34 90.65-32.89 42.43-78.27 78.12Zm44.61 216.77L633.23-269.69q-26.54 11.77-65.88 20.73Q528-240 480-240q-131 0-238.23-71.58Q134.54-383.15 83.08-500q23.3-53 61.46-99.27 38.15-46.27 81.46-77.65l-111.54-112 28.31-28.31 674.46 674.46-28.31 28.31ZM254.31-648.62q-34.39 24.47-70.31 64.31-35.92 39.85-56 84.31 50 101 143.5 160.5T480-280q34.62 0 69.77-6.73t52.85-13.58L537.38-366q-9.46 5.31-26.38 8.73-16.92 3.42-31 3.42-61.15 0-103.65-42.5-42.5-42.5-42.5-103.65 0-13.31 3.42-29.85 3.42-16.53 8.73-27.53l-91.69-91.24ZM541-531Zm-112.54 56.54Z" />
  </svg>
);

const EditIcon2 = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    height="20px"
    viewBox="0 -960 960 960"
    width="20px"
    fill="#5f6368"
  >
    <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z" />
  </svg>
);

const FinalLogin = ({ setActiveState, entredEmail }) => {
  const { useSetRecoilState } = Recoil;
  const [serverError, setServerError] = useState(null);
  const [alert, setAlert] = useState(null);
  const [showPassword, setShowPassword] = useState(false);
  const { routes, setRoutes } = useRoute();

  const loginUserValidationSchema = z.object({
    // email: z.string().email(),
    password: z.string().nonempty({
      message: "Password is required.",
    }),
  });

  // const { getMe } = useMe();
  const setUserDetails = useSetRecoilState(userDetailsAtom);

  const setItemAsync = async (key, value, days = env.COOKIE_EXPIRE) => {
    return new Promise((resolve) => {
      setCookie(key, value, days);
      resolve();
    });
  };

  const { mutate: login, isLoading } = useMutation({
    mutationKey: ["loginUser"],
    mutationFn: async (input) => {
      try {
        const response = await Client.authentication.login({
          username: entredEmail,
          password: input.password,
        });
        return response;
      } catch (error) {
        throw error;
      }
    },
    onSuccess: async (data) => {
      if (!data.data.tokenData.token) {
        setAlert({ message: "Wrong email or password", type: "error" });
        return;
      }

      const currentDomain = window.location.origin;
      const portal = data.data.loggedInDetails.portals.find(
        (item) => item.portalUrl === currentDomain
      );
      setPortal(portal);
      if (
        data.data.loggedInDetails &&
        data.data.loggedInDetails.hubspot &&
        data.data.loggedInDetails.hubspot.twoFa
      ) {
        setLoggedInDetails(data.data);
        setTwoFa({ twoFa: data.data.loggedInDetails.hubspot.twoFa });
        window.location.hash = "/login/tow-fa";
      } else {
        await setItemAsync(env.AUTH_TOKEN_KEY, data.data.tokenData.token);
        // getMe(); // Fetch user details
        // Use if-else to check if routes exist
        if (routes && routes.length > 0) {
          const firstRoute = routes[0].path;
          window.location.hash = firstRoute;
        } else {
          window.location.hash = "/no-routes";
        }
      }
      setAlert({ message: data.statusMsg, type: "success" });
    },

    onError: (error) => {
      let errorMessage = "An unexpected error occurred.";

      if (error.response && error.response.data) {
        const errorData = error.response.data.detailedMessage;
        const errors = error.response.data.errors;
        setServerError(errors);

        errorMessage =
          typeof errorData === "object" ? JSON.stringify(errorData) : errorData;
      }

      setAlert({ message: errorMessage, type: "error" });
    },
  });

  const onSubmit = (data) => {
    login(data);
  };

  const togglePasswordVisibility = () => {
    setShowPassword((prevState) => !prevState);
  };
  const { isLargeScreen, isMediumScreen, isSmallScreen } = useResponsive();

  return (
    <div className="flex items-center bg-flatGray dark:bg-gray-800 justify-center h-screen">
      {alert && (
        <Alert
          message={alert.message}
          type={alert.type}
          onClose={() => setAlert(null)}
        />
      )}
      <div
        className={`dark:bg-dark-200 gap-4 bg-cleanWhite py-8 px-4 flex flex-col items-center justify-center rounded-lg ${
          isLargeScreen && "w-[30%]"
        }  ${isMediumScreen && "w-[45%]"}  ${isSmallScreen && "w-[85%]"} `}
      >
        <div className="">
          <div className="w-[80px]">
            <img
              src={hubSpotUserDetails.hubspotPortals.portalSettings.smallLogo}
              alt="Logo"
              className={`h-auto `}
            />
          </div>
        </div>
        <p className="text-center dark:text-white">
          {baseCompanyOptions.welcomeMessage || "Welcome"}
        </p>
        <div className="w-full">
          <Form
            onSubmit={onSubmit}
            validationSchema={loginUserValidationSchema}
            serverError={serverError}
            className="dark:bg-dark-200"
          >
            {({ register, formState: { errors } }) => (
              <div className="text-gray-800 dark:text-gray-200">
                <FormItem>
                  <FormLabel className="text-xs font-semibold text-gray-800 dark:text-gray-300 focus:text-blue-600">
                    Email
                  </FormLabel>
                  <FormControl>
                    <div>
                      <div className="relative">
                        <Input
                          height="medium"
                          icon={emailIcon}
                          placeholder="Email"
                          className=""
                          {...register("email")}
                          defaultValue={entredEmail}
                          disabled
                          readonly
                        />
                        <span
                          className="absolute right-2 top-3 cursor-pointer"
                          onClick={() => setActiveState("pre-login")}
                        >
                          <EditIcon2 />
                        </span>
                      </div>
                    </div>
                  </FormControl>
                  {errors.username && (
                    <FormMessage className="text-red-600 dark:text-red-400">
                      {errors.username.message}
                    </FormMessage>
                  )}
                </FormItem>
                <FormItem>
                  <FormLabel className="text-xs font-semibold text-gray-800 dark:text-gray-300 focus:text-blue-600">
                    Password
                  </FormLabel>
                  <FormControl>
                    <div className="relative">
                      <Input
                        placeholder="Password"
                        icon={passwordIcon}
                        type={showPassword ? "text" : "password"}
                        className=" "
                        {...register("password")}
                      />
                      <span
                        className="absolute right-2 top-3 cursor-pointer"
                        onClick={togglePasswordVisibility}
                      >
                        {showPassword ? <EyeIcon /> : <EyeOffIcon />}
                      </span>
                    </div>
                  </FormControl>
                  {errors.password && (
                    <FormMessage className="text-red-600 dark:text-red-400">
                      {errors.password.message}
                    </FormMessage>
                  )}
                </FormItem>
                <div className="flex justify-end items-center">
                  <div>
                    <NavLink
                      to="/login"
                      onClick={() => setActiveState("pre-login")}
                    >
                      <p className="text-black text-xs dark:text-gray-300">
                        Back to enter email
                      </p>
                    </NavLink>
                  </div>
                </div>
                <div className="mt-4 flex flex-col justify-center items-center">
                  <Button className="w-full  " isLoading={isLoading}>
                    Login
                  </Button>
                </div>
              </div>
            )}
          </Form>
        </div>
      </div>
    </div>
  );
};
